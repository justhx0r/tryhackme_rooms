{'image': 'https://tryhackme-images.s3.amazonaws.com/room-icons/5094579e582d09186101a3b3eec8452a.png', 'title': 'Registry Persistence Detection', 'description': 'Learn to use the AutoRuns PowerShell module to detect persistence mechanisms that use the Registry.', 'code': 'registrypersistencedetection', 'users': 1316, 'tags': ['malware', 'persistence', 'malware behaviors', 'mbc', 'powershell', 'mitre', 'registry', 'autoruns', 'remediation', 'startup', 'run keys', 'hklm', 'hkcu'], 'type': 'walkthrough', 'difficulty': 'easy', 'userCompleted': False, 'upVotes': 90, 'created': '2022-09-19T02:52:30.160Z', 'published': '2023-10-10T15:00:00.611Z', 'freeToUse': True, 'businessOnly': False, 'headerImage': 'https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/40775cbb085ec2b639ef2a6307b467bc.png', 'creator': 'accidentalrebel', 'tasks': [{'taskTitle': 'Intro', 'taskDesc': '<p><img />One crucial step that malware does upon successful execution on a target machine is to ensure that it can stay there even after a reboot or removal attempt. This is possible using various techniques, collectively called <i>"malware persistence mechanisms"</i>.</p><p>This room will give you an overview of these techniques and introduce a tool that can help detect them and aid in removal.</p><p><span style="font-size:24px">Learning Objectives</span></p><ul><li>Learn how malware persists in a machine</li><li>Learn how malware uses the Registry as a persistence mechanism</li><li>Learn how to use the AutoRuns PowerShell module to detect and remediate persistence mechanisms</li></ul><p><span style="font-size:24px">Connecting to the Machine</span></p><p>We will use the Virtual Machine provided to complete the tasks in this room. You can start it in split-screen view by clicking on the green "Start Machine" button on the upper right section of this task. If the VM is not visible, use the blue "Show Split View" button at the top-right of the page. Alternatively, you can connect to the\xa0<a class="WBjz0o16 glossary-term">VM</a>\xa0using the credentials below via "Remote Desktop".\n\n</p><div style="display:flex;justify-content:center">\n\t<div style="width:450px;display:flex;align-items:center;background-color:rgb(230, 230, 230);border-radius:8px;box-shadow:5px 5px 5px;padding:20px;margin-bottom:15px;--darkreader-inline-bgcolor:#26292b">\n\t\t<img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/63588b5ef586912c7d03c4f0/room-content/be629720b11a294819516c1d4e738c92.png" alt="THM key" style="max-height:120px" />\n\t\t<span style="text-align:left;padding-left:20px;font-size:20px;width:100%">\n\t\t<table style="width:100%;border-spacing:4px;border-collapse:separate">\n\t\t\t<tbody><tr><td style="width:110px"><b>Username </b></td><td style="background-color:white;border-radius:5px;padding:4px;--darkreader-inline-bgcolor:#181a1b">Administrator</td></tr>\n\t\t\t<tr><td><b>Password </b></td><td style="background-color:white;border-radius:5px;padding:4px;--darkreader-inline-bgcolor:#181a1b">Passw0rd!</td></tr>\n<tr><td><b>IP </b></td><td style="background-color:white;border-radius:5px;padding:4px;--darkreader-inline-bgcolor:#181a1b">MACHINE_IP</td></tr>\n\t\t</tbody></table>\n\t\t</span>\n\t</div>\n</div>', 'taskType': 'vm', 'taskNo': 1, 'taskCreated': '2022-09-19T03:17:28.455Z', 'taskDeadline': None, 'tasksInfo': [], 'uploadId': '636d4fe3786f240053d58ebd', 'questions': [{'questionNo': 1, 'question': '<div class="room-task-question-details">Read the above, start the machine, and log in.</div><div class="room-task-input" style="display:grid;grid-template-columns:65% auto;gap:10px;grid-auto-flow:column;align-items:center"><div class="room-task-input-questions" style="display:flex;position:relative;flex:4 1 auto;max-width:800px"></div></div>', 'hint': ''}]}, {'taskTitle': 'Intro to Malware Persistence Mechanisms', 'taskDesc': '<p><span style="font-size:1rem">The term<i> "malware persistence"</i>\xa0can be defined as:</span><br /></p><p style="margin-left:25px"><i>"Behaviors that enable malware to remain on a system regardless of system events, such as reboots."</i></p><p><span style="font-size:1rem">There are multiple ways malware can gain persistence. T</span><span style="font-size:1rem">he technique/s used vary depending on the targeted operating system, ease of implementation, level of stealthiness, or, sometimes, based on the preference of the malware author.\xa0</span><span style="font-size:1rem">Examples of these techniques would\xa0be modifying an operating system\'s boot sector, installing malicious configurations, or hijacking execution flow.</span></p><p>In Windows, the most common and easiest-to-implement technique is the abuse of Windows Registry Run keys.</p><p>The Windows Registry is a database of low-level operating systems and application settings. The Run keys are specific keys within the Registry that contain a path that runs every time a user logs on, and they are listed below:</p><ul><li><span style="font-size:1rem"><u>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</u> - Run path when the current user logs in</span></li><li><span style="font-size:1rem"><u>HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</u> - Run path when <i>any</i> user logs in</span></li><li><u>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce</u> - Run path when the current user logs in, then delete<br /></li><li><span style="font-size:1rem"><u>HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce</u> - Run path when <i>any</i> user logs in, then delete</span></li></ul><p><span style="font-size:1rem">To view these keys, open the <i><u>Registry Editor</u></i> by searching for "Regedit" on Windows Search or double-clicking on the Regedit icon pinned on the Windows taskbar.</span></p><p><span style="font-size:1rem">This is what the Registry Editor window looks like:</span></p><p style="text-align:center"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f2e7dc42867e661a3fb0afa/room-content/26ab547b1ae674fea0644d4d0c2508a3.png" alt="Screenshot of Windows\' built-in Registry editor" /></p><p style="text-align:left"><span style="font-size:1rem">If you want to view the value for one of the Run keys, e</span><span style="font-size:1rem">xpand the folders and their subfolders until you reach the key you are looking for. For example:</span></p><ul><li><span style="font-size:1rem">HKEY_LOCAL_MACHINE &gt;\xa0</span>Software &gt; Microsoft &gt; Windows &gt; CurrentVersion &gt; Run</li></ul>', 'taskType': 'none', 'taskNo': 2, 'taskCreated': '2022-09-20T04:06:02.762Z', 'taskDeadline': None, 'tasksInfo': [], 'uploadId': '', 'questions': [{'questionNo': 1, 'question': 'What is the value "Name" of the suspicious registry entry that runs during startup? Include the parenthesis.', 'hint': ''}, {'questionNo': 2, 'question': '<p>What is the value "Data" of the suspicious registry entry that runs during startup?<br /></p>', 'hint': ''}, {'questionNo': 3, 'question': '<p>What string is displayed on the console when the suspicious file runs?</p>', 'hint': ''}]}, {'taskTitle': 'Intro to the AutoRuns PowerShell Module', 'taskDesc': '<div>As you\'ve seen in the previous task, it is possible to detect the existence of persistence mechanisms in the Registry by manually checking keys. However, other registry keys can be used to establish persistence, and they are not as obvious, making them harder to find.\xa0<span style="font-size:1rem">Fortunately, some tools can help us with this problem.</span></div><div><span style="font-size:1rem"><br /></span></div><div><img /><span style="font-size:1rem">A widely-used tool from Microsoft called </span><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/autoruns" target="_blank">AutoRuns</a><span style="font-size:1rem">\xa0checks all possible locations where a program can automatically run on start-up or when a user logs in. This tool does what we need, but it is not the one we\'ll be using for this room (If you still want to check it out, try the </span><a href="https://tryhackme.com/room/btsysinternalssg" target="_blank">SysInternals room</a><span style="font-size:1rem">).</span></div><div><span style="font-size:1rem"><br /></span></div><div style="text-align:center"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f2e7dc42867e661a3fb0afa/room-content/e5001ee1f2d98741900e98eee36186a4.png" alt="AutoRuns PowerShell Module logo" style="font-size:1rem;text-align:left;width:15%" /></div><div style="text-align:center"><br /></div><div><span style="font-size:1rem">For this room, we\'ll use the <a href="https://github.com/p0w3rsh3ll/AutoRuns" target="_blank">AutoRuns PowerShell module</a></span><span style="font-size:1rem">. It does the same thing as the original AutoRuns tool. Still, it allows us to leverage the benefits of PowerShell scripting and has a baseline feature for comparing current snapshots to previous ones. You\'ll see why these features are essential later on.</span></div><div><span style="font-size:1rem"><br /></span></div><div><span style="font-size:1rem">The Windows machine already has the AutoRuns PowerShell module installed. To use it, open PowerShell in Administrator mode by clicking on the PowerShell icon on the Windows Taskbar at the bottom of the screen. Once the PowerShell window appears, type the following to view the available commands:</span></div><div><span style="font-size:1rem"><br /></span></div>\n\n<div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Get-Command -Module AutoRuns\nCommandType     Name                                               Version    Source\n-----------     ----                                               -------    ------\nFunction        Compare-AutoRunsBaseLine                           14.0       AutoRuns\nFunction        Get-PSAutorun                                      14.0       AutoRuns\nFunction        New-AutoRunsBaseLine                               14.0       AutoRuns</code>\n        </pre></div></div><div><span style="font-size:1rem">To learn more about each AutoRuns command,\xa0</span>we can use the Get-help cmdlet along with each AutoRun command name as shown below:</div><div><span style="font-size:1rem"><br /></span></div>\n\n<div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Get-Help CHANGETHIS</code>\n        </pre>\n    </div>\n</div>\n\n<div>You can also check out\xa0<span style="font-size:1rem">the tool\'s </span><a href="https://github.com/p0w3rsh3ll/AutoRuns" target="_blank">ReadMe page</a><span style="font-size:1rem">\xa0for more information.</span></div>', 'taskType': 'none', 'taskNo': 3, 'taskCreated': '2022-09-21T06:04:06.819Z', 'taskDeadline': None, 'tasksInfo': [], 'uploadId': '', 'questions': [{'questionNo': 1, 'question': 'What AutoRun function is used for getting and displaying the auto-run entries?', 'hint': 'Use the Get-Help cmdlet with the Autorun commands to answer the question.'}, {'questionNo': 2, 'question': '<p>What AutoRun function is used for creating a baseline file from Autoruns artifact(s)?</p>', 'hint': 'Use the Get-Help cmdlet with the Autorun commands to answer the question.'}, {'questionNo': 3, 'question': '<p>What AutoRun function is used for comparing two baseline files of Autoruns artifact(s)?<br /></p>', 'hint': 'Use the Get-Help cmdlet with the Autorun commands to answer the question.'}]}, {'taskTitle': 'Filtering AutoRuns Entries', 'taskDesc': '<p>AutoRuns PowerShell has a function called <u>Get-PSAutorun</u> that will list all possible auto-start mechanisms available on the machine. It makes this list by looking at categories like the Registry, Windows services, WMI entries, DLL hijacking, and more. Because of this, the output of the command will return many results that might be challenging if not adequately filtered.</p><p style="text-align:center">\n\n</p><div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Get-PSAutorun\n\nPath          : HKLM:\\System\\CurrentControlSet\\Control\\Session Manager\nItem          : BootExecute\nCategory      : Boot Execute\nValue         : autocheck autochk *\nImagePath     : C:\\Windows\\system32\\autochk.exe\nSize          : 956416\nLastWriteTime : 11/6/2022 4:24:46 AM\nVersion       : 10.0.17763.1697\n\nPath          : HKLM:\\SOFTWARE\\\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\nItem          : {003e0278-eca8-4bb8-a256-3689ca1c2600}\nCategory      : Explorer\nValue         : C:\\Windows\\system32\\shell32.dll\nImagePath     : C:\\Windows\\system32\\shell32.dll\nSize          : 22153696\nLastWriteTime : 11/6/2022 4:25:16 AM\nVersion       : 10.0.17763.1911\n\nPath          : HKLM:\\SOFTWARE\\\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\nItem          : {3BF043EF-A974-49B3-8322-B853CF1E5EC5}\nCategory      : Explorer\nValue         : C:\\Windows\\System32\\SndVolSSO.dll\nImagePath     : C:\\Windows\\System32\\SndVolSSO.dll\nSize          : 823808\nLastWriteTime : 11/6/2022 4:25:22 AM\nVersion       : 10.0.17763.652\n\n...\n        </code></pre>\n    </div>\n</div>\n\n<p>Piping the result of the command above to the <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/out-gridview?view=powershell-7.2" target="_blank">Out-GridView</a> cmdlet can make the output more readable.</p>\n\n<div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Get-PSAutorun | Out-GridView</code>\n        </pre>\n    </div>\n</div>\n\n<p>The above command will open a new window showing the following output:</p><p style="text-align:center"><img alt="Output of AutoRuns PowerShell module using Out-GridView." src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f2e7dc42867e661a3fb0afa/room-content/163f4ca9dce39532af44305163d5638b.png" /><br /></p><p><i><b>Note: </b>Wait for a couple of minutes for the tool to finish populating the results</i></p><p><span style="font-size:1rem">The results above list all possible places a program can run on start-up. You can filter the results by specifying keywords in the "Filter" bar at the top of the window. You can also sort the results by clicking on the column headers.</span></p><p><span style="font-size:1rem">We can specify parameter switches when calling the function to filter the result according to the previously mentioned categories. Open a new PowerShell window, and use the </span><code class="language-powershell">Get-Help</code><span style="font-size:1rem"> command to list the available parameters.</span><br /></p>\n\n<div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Get-Help Get-PSAutorun -detailed</code>\n        </pre>\n    </div>\n</div>', 'taskType': 'none', 'taskNo': 4, 'taskCreated': '2022-09-21T09:15:22.301Z', 'taskDeadline': None, 'tasksInfo': [], 'uploadId': '', 'questions': [{'questionNo': 1, 'question': 'What parameter switch is used for filtering for artifacts related to boot execution of images?\xa0', 'hint': ''}, {'questionNo': 2, 'question': '<p>How many entries are outputted using the parameter switch from the previous question?</p>', 'hint': ''}, {'questionNo': 3, 'question': '<p>What parameter switch is used for filtering for artifacts related to printer driver and status monitors?<br /></p>', 'hint': ''}, {'questionNo': 4, 'question': '<p>How many entries are listed in the output using the parameter switch from the previous question?<br /></p>', 'hint': ''}, {'questionNo': 5, 'question': '<p>What parameter is used to add a new column to show whether a file is digitally signed?<br /></p>', 'hint': ''}, {'questionNo': 6, 'question': '<p>Searching all categories, how many entries have the "Signed" column set to "false"?<br /></p>', 'hint': 'Specify the "VerifyDigitalSignature" parameter when calling Get-PSAutorun to get the "Signed" column.'}, {'questionNo': 7, 'question': '<p>Try to answer the previous question with just Powershell and without using Out-GridView.</p>', 'hint': ''}]}, {'taskTitle': 'Comparing to a Baseline', 'taskDesc': '<p>While filtering via parameter switches helps reduce the output, there is still a lot to go through. This is where the baseline creation and comparison feature of the AutoRuns PowerShell module is helpful, as only the entries that differ from the baseline are shown in the results.</p><p>After creating this room\'s machine, a baseline file was generated and saved in the\xa0<i>~/Documents</i> folder. This file serves as a snapshot of the Registry before the malware ran.</p><p style="text-align:center"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f2e7dc42867e661a3fb0afa/room-content/818f765681dd5268592055db8141d0f5.png" alt="Screenshot showing directory of baseline file." /><br /></p><p style="text-align:center"></p><p style="text-align:left">To check what Registry keys were changed, a new baseline file needs to be created using the\xa0<code class="language-powershell">New-AutoRunsBaseLine</code> function.</p>\n\n\n<div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Get-PSAutorun -VerifyDigitalSignature |\n&gt;&gt; Where { -not($_.isOSbinary)} |\n&gt;&gt; New-AutoRunsBaseLine -Verbose</code>\n        </pre>\n    </div>\n</div><i><b>\n\nNote: </b>Generating a new baseline file using the code above will take a few minutes. So please be patient.</i><p></p><p>When done, the new baseline file is added to the <i>~/Documents</i> folder.</p><p style="text-align:center"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f2e7dc42867e661a3fb0afa/room-content/c061cb72d15e1890c3468c8d09a585bd.png" alt="Screenshot showing directory of baseline files." /></p><p>The two baseline files can now be compared using the following command:</p>\n\n<div class="terminal-container">\n    <div class="terminal-content">\n        <div class="terminal-top">\n            Administrator: Windows PowerShell\n        </div>\n        <pre class="terminal-code">           <code class="language-powershell">PS C:\\&gt; Compare-AutoRunsBaseLine -Verbose | Out-GridView</code>\n        </pre>\n    </div>\n</div>\n\n<p><i><b>Note: </b>\xa0Make sure there are always two baseline files in the ~/Documents folder when comparing. Delete the other files you do not need to avoid confusion.</i><br /></p>', 'taskType': 'none', 'taskNo': 5, 'taskCreated': '2022-09-21T11:12:56.443Z', 'taskDeadline': None, 'tasksInfo': [], 'uploadId': '', 'questions': [{'questionNo': 1, 'question': 'There is another suspicious logon Registry entry. What is the full path of this key?', 'hint': ''}, {'questionNo': 2, 'question': 'What is the value item name of the suspicious Registry entry from question #1?', 'hint': ''}, {'questionNo': 3, 'question': '<p><span>What is the value data of the suspicious Registry entry from question #1?</span><br /></p>', 'hint': ''}, {'questionNo': 4, 'question': '<p>What is the category that AutoRuns assigned to the entry from question #1?</p>', 'hint': ''}, {'questionNo': 5, 'question': '<p><span>What string is displayed on the console when the suspicious file ran?</span><br /></p>', 'hint': ''}]}, {'taskTitle': 'Conclusion', 'taskDesc': '<p>We can now take the necessary steps to remove the malicious registry keys and files we found. In this case, it is as easy as deleting or modifying the entries via "RegEdit" and ensuring they are gone after a reboot.</p><p style="text-align:center"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5f2e7dc42867e661a3fb0afa/room-content/baf50a9270f52c9f57736ff8c11e084c.png" alt="Screenshot showing how to modify entries via RegEdit." /><br /></p><p><span style="font-size:1rem">Hopefully, this room has given you an idea of how malware uses the Windows Registry to maintain persistence on a target machine. While there are other techniques that malware uses, the same tool can be used in detecting most of them.</span><br /></p>', 'taskType': 'none', 'taskNo': 6, 'taskCreated': '2022-09-21T15:04:02.445Z', 'taskDeadline': None, 'tasksInfo': [], 'uploadId': '', 'questions': [{'questionNo': 1, 'question': 'Congratulations! You have cleaned your machine of persistence mechanisms... for now.', 'hint': ''}]}]}